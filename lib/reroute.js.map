{"version":3,"file":"reroute.js","sources":["../src/utils/logger.js","../src/utils/deepmerge.js","../src/utils/cache-service.js","../src/reroute.js","../src/reroute-origin.js"],"sourcesContent":["import debug from 'debug';\nconst log = debug('reroute:log');\nlog.log = console.log.bind(console);\n\nexport default log;\n","import merge from 'deepmerge';\n\nconst deepmerge = (x, y, { arrayMerge, ...rest } = {}) =>\n  merge(x, y, { ...rest, arrayMerge: combineMerge });\n\nconst all = (arr, { arrayMerge, ...rest } = {}) =>\n  merge.all(arr, { ...rest, arrayMerge: combineMerge });\n\nconst emptyTarget = (value) => (Array.isArray(value) ? [] : {});\nconst clone = (value, options) => merge(emptyTarget(value), value, options);\nconst combineMerge = (target, source, options) => {\n  const destination = target.slice();\n  source.forEach((e, i) => {\n    if (typeof destination[i] === 'undefined') {\n      const cloneRequested = options.clone !== false;\n      const shouldClone = cloneRequested && options.isMergeableObject(e);\n      destination[i] = shouldClone ? clone(e, options) : e;\n    } else if (options.isMergeableObject(e)) {\n      destination[i] = merge(target[i], e, options);\n    } else if (target.indexOf(e) === -1) {\n      destination.push(e);\n    }\n  });\n  return destination;\n};\n\nexport default deepmerge;\nexport { all };\n","import NodeCache from 'node-cache';\n\nclass Cache {\n  constructor(ttlSeconds) {\n    this.cache = new NodeCache({\n      stdTTL: ttlSeconds,\n      checkperiod: ttlSeconds * 0.2,\n      useClones: false,\n    });\n\n    this.ttl = ttlSeconds;\n  }\n\n  get(key, storeFunction) {\n    if (this.ttl > 0) {\n      const value = this.cache.get(key);\n      if (value) {\n        return Promise.resolve(value);\n      }\n    }\n    return storeFunction().then((result) => {\n      this.ttl > 0 && this.cache.set(key, result, this.ttl);\n      return result;\n    });\n  }\n\n  del(keys) {\n    this.cache.del(keys);\n  }\n\n  setDefaultTtl(ttl) {\n    this.ttl = ttl;\n    this.ttl === 0 && this.flush();\n  }\n\n  delStartWith(startStr = '') {\n    if (!startStr) {\n      return;\n    }\n\n    const keys = this.cache.keys();\n    for (const key of keys) {\n      if (key.indexOf(startStr) === 0) {\n        this.del(key);\n      }\n    }\n  }\n\n  flush() {\n    this.cache.flushAll();\n  }\n}\n\nexport default Cache;\n","import AWS from 'aws-sdk';\nimport { STATUS_CODES } from 'http';\nimport logger from './utils/logger';\nimport axios from 'axios';\nimport _find from 'lodash.find';\nimport _reduce from 'lodash.reduce';\nimport _omit from 'lodash.omit';\nimport _omitBy from 'lodash.omitby';\nimport { parse } from 'url';\nimport path from 'path';\nimport pathMatch from 'path-match';\nimport langParser from 'accept-language-parser';\nimport UAParser from 'ua-parser-js';\nimport semver from 'semver';\nimport merge, { all as mergeAll } from './utils/deepmerge';\nimport CacheService from './utils/cache-service';\n\nconst ttl = 300; // default TTL of 30 seconds\nconst cache = new CacheService(ttl);\n\naxios.interceptors.response.use(\n  function (response) {\n    // Do something with response data\n    return response;\n  },\n  function (error) {\n    // Do something with response error\n    return Promise.reject(error);\n  },\n);\n\nconst route = pathMatch({\n  sensitive: false,\n  strict: false,\n  end: true,\n});\n\nlet options, S3;\nconst rerouteMiddleware = async (opts = {}, handler, next) => {\n  const { request } = handler.event.Records[0].cf;\n  const { origin } = request;\n  const [host, country, language, userAgent] = getHeaderValues(\n    ['host', 'cloudfront-viewer-country', 'accept-language', 'user-agent'],\n    request.headers,\n  );\n  const s3DomainName = origin && origin.s3 && origin.s3.domainName;\n  const originBucket =\n    s3DomainName && s3DomainName.replace('.s3.amazonaws.com', '');\n  const defaults = {\n    file: '_redirects',\n    rules: undefined,\n    multiFile: false,\n    rulesBucket: \"originBucket\",\n    rulesURL: \"\",\n    regex: {\n      htmlEnd: /(.*)\\/((.*)\\.html?)$/,\n      ignoreRules: /^(?:\\s*(?:#.*)*)$[\\r\\n]{0,1}|(?:#.*)*/gm,\n      ruleline: /([^\\s\\r\\n]+)(?:\\s+)([^\\s\\r\\n]+)(?:\\s+(\\d+)([!]?))?(?:(?:\\s+)?([^\\s\\r\\n]+))?/,\n      absoluteUri: /^(?:[a-z]+:)?\\/\\//,\n    },\n    defaultStatus: 301,\n    redirectStatuses: [301, 302, 303],\n    friendlyUrls: true,\n    defaultDoc: `index.html`,\n    custom404: `404.html`,\n    cacheTtl: ttl,\n    incomingProtocol: 'https://',\n    s3Options: { httpOptions: { connectTimeout: 2000 } }, // default 2 seconds\n  };\n  options = mergeAll([\n    defaults,\n    opts,\n    {\n      originBucket,\n      host,\n      country,\n      language,\n      userAgent,\n    },\n  ]);\n  cache.setDefaultTtl(options.cacheTtl);\n\n  S3 = S3 || new AWS.S3(options.s3Options);\n\n  logger(`\n    Raw Event:\n    ${JSON.stringify(handler.event)}\n\n    Middleware Options:\n    ${JSON.stringify(options)}\n    ---- Request ----\n    URI: ${request.uri}\n    Host: ${options.host}\n    Origin: ${s3DomainName}\n    Country: ${options.country}\n    Language: ${options.language}\n    UserAgent: ${options.userAgent}\n    `);\n\n  // Origin must be S3\n  if (!s3DomainName) throw new Error('Must use S3 as Origin');\n\n  try {\n    // Check if file exists\n    const keyExists = await doesKeyExist(request.uri);\n\n    // Detect if needing friendly URLs\n    const isUnFriendlyUrl =\n      options.friendlyUrls && request.uri.match(options.regex.htmlEnd);\n\n    const [first, fullpath, file, filename] = isUnFriendlyUrl || [];\n    const isIndex = filename === 'index';\n\n    let event;\n    // Apply Friendly URLs if file doesn't exist\n    // Do not apply any rules and Redirect\n    if (isUnFriendlyUrl && (!keyExists || isIndex)) {\n      const end = isIndex ? '' : `${filename}/`;\n      const finalKey = `${fullpath}/${end}`;\n      logger('UN-FriendlyURL [from:to]: ', request.uri, finalKey);\n      event = redirect(finalKey, 301);\n    } else {\n      // Gather and parse rules\n      const data = await getRedirectData();\n      logger('Rules: ', data);\n\n      // Find URI match in the rules\n      const match = findMatch(\n        data,\n        request.uri,\n        host,\n        options.incomingProtocol,\n      );\n      if (match) {\n        logger('Match FOUND: ', match.parsedTo);\n        // Match: match found\n        // Use status to decide how to handle\n        event = isRedirectURI(match.status)\n          ? redirect(match.parsedTo, match.status)\n          : isAbsoluteURI(match.parsedTo)\n          ? await proxy(match.parsedTo, handler.event)\n          : await rewrite(\n              forceDefaultDoc(match.parsedTo),\n              s3DomainName,\n              handler.event,\n            );\n      } else {\n        logger('NO Match');\n        // Pass-Through: No match, so other then DefaultDoc, let it pass through\n        event = await rewrite(\n          forceDefaultDoc(request.uri),\n          s3DomainName,\n          handler.event,\n        );\n      }\n    }\n\n    handler.event = event;\n  } catch (err) {\n    logger('Throwing Error for main thread');\n    throw err;\n  }\n\n  logger('RETURNING EVENT!!!!', handler.event);\n  return;\n};\n\n///////////////////////\n// Utils     //\n///////////////////////\nconst getHeaderValues = (paramArr, headers) =>\n  paramArr.map(\n    (param) => headers[param] && headers[param][0] && headers[param][0].value,\n  );\nconst isRedirectURI = (status) => options.redirectStatuses.includes(status);\n\nconst isAbsoluteURI = (to) => {\n  const test = options.regex.absoluteUri.test(to);\n  logger('isAbsoluteURI: ', test, to);\n  return test;\n};\n\nconst capitalizeParam = (param) =>\n  param\n    .split('-')\n    .map((i) => i.charAt(0).toUpperCase() + i.slice(1))\n    .join('-');\n\nconst forceDefaultDoc = (uri) =>\n  path.extname(uri) === '' && !!options.defaultDoc\n    ? path.join(uri, options.defaultDoc)\n    : uri;\n\nconst lambdaReponseToObj = (req) => {\n  const { method, body } = req;\n  return {\n    method,\n    headers: _omit(\n      _reduce(\n        req.headers,\n        (result, value, key) => ({ ...result, [value[0].key]: value[0].value }),\n        {},\n      ),\n      ['Host'],\n    ),\n  };\n};\n\nconst blacklistedHeaders = {\n  exact: [\n    'Connection',\n    'Expect',\n    'Keep-alive',\n    'Proxy-Authenticate',\n    'Proxy-Authorization',\n    'Proxy-Connection',\n    'Trailer',\n    'Upgrade',\n    'X-Accel-Buffering',\n    'X-Accel-Charset',\n    'X-Accel-Limit-Rate',\n    'X-Accel-Redirect',\n    'X-Cache',\n    'X-Forwarded-Proto',\n    'X-Real-IP',\n    'Accept-Encoding',\n    'Content-Length',\n    'If-Modified-Since',\n    'If-None-Match',\n    'If-Range',\n    'If-Unmodified-Since',\n    'Range',\n    'Transfer-Encoding',\n    'Via',\n  ],\n  startsWith: ['X-Amzn-', 'X-Amz-Cf-', 'X-Edge-'],\n};\nconst isBlacklistedProperty = (name) =>\n  blacklistedHeaders.exact.includes(name) ||\n  !!blacklistedHeaders.startsWith.find((i) => name.startsWith(i));\n\n///////////////////////\n// Rules Parsing     //\n///////////////////////\nconst replacePlaceholders = (obj, pattern) =>\n  pattern.replace(/:(?!splat)(\\w+)/g, (_, k) => obj[k]);\n\nconst replaceSplats = (obj, pattern) =>\n  _reduce(\n    obj,\n    (result, value, key) => result.replace(/(:splat)/g, obj[key]),\n    pattern,\n  ).replace(/(:splat)/g, '');\n\nconst replaceAll = (obj, pattern) =>\n  replaceSplats(obj, replacePlaceholders(obj, pattern));\n\nconst parseConditions = (conditions) =>\n  !!conditions\n    ? conditions.split(';').reduce((results, next) => {\n        const [unused, key, value] = next.split(/([^=]*)=(.*)/);\n        return { ...results, [key.toLowerCase()]: value.split(',') };\n      }, {})\n    : {};\n\nconst parseRules = (stringFile) => {\n  logger('Parsing String: ', stringFile);\n  return (\n    stringFile\n      // remove empty and commented lines\n      .replace(options.regex.ignoreRules, '')\n      // split all lines\n      .split(/[\\r\\n]/gm)\n      // strip out the last line break\n      .filter((l) => l !== '')\n      .map((l) => {\n        // regex\n        const [first, from, to, status, force, conditions] = l.match(\n          options.regex.ruleline,\n        );\n        // restructure into object\n        return {\n          from,\n          to,\n          status: status ? parseInt(status, 10) : options.defaultStatus,\n          force: !!force,\n          conditions: parseConditions(conditions),\n        };\n      })\n  );\n};\n\nconst countryParser = (supportedCountryArray, acceptCountryHeader) =>\n  supportedCountryArray\n    .map((c) => c.toLowerCase())\n    .includes(acceptCountryHeader.toLowerCase());\n\nconst userAgentParser = (testuserAgentArray, userAgentHeader) => {\n  const { name: browser, version } = UAParser(userAgentHeader).browser;\n  const match = _find(testuserAgentArray, (uaRule) => {\n    const [browserRule, versionRule] = uaRule.split(':');\n    const cleanVersion = semver.valid(semver.coerce(version));\n    const isVersion = semver.satisfies(cleanVersion, versionRule);\n    const isBrowser = browser === browserRule;\n    const isMatch = isBrowser && isVersion;\n    return isMatch;\n  });\n  return !!match;\n};\n\nconst findMatch = (data, path, host, protocol) => {\n  let params;\n  const fullUri = host && `${protocol}${host}${path}`;\n  const match = _find(data, (o) => {\n    const from = route(o.from);\n    params = isAbsoluteURI(o.from) ? from(fullUri) : from(parse(path).pathname);\n\n    // If there specific language rules, do they match\n    const languagePass = !!o.conditions.language\n      ? !!options.language &&\n        !!langParser.pick(o.conditions.language, options.language, {\n          loose: true,\n        })\n      : true;\n\n    // If there specific country rules, do they match\n    const countryPass = !!o.conditions.country\n      ? !!options.country &&\n        countryParser(o.conditions.country, options.country)\n      : true;\n\n    // If there specific user-agent rules, do they match\n    const agentPass = !!o.conditions.useragent\n      ? !!options.userAgent &&\n        userAgentParser(o.conditions.useragent, options.userAgent)\n      : true;\n\n    // Let's make sure all our conditions pass IF set\n    const passesConditions = languagePass && countryPass && agentPass;\n    return params !== false && passesConditions;\n  });\n  return match && { ...match, parsedTo: replaceAll(params, match.to) };\n};\n\n///////////////////////\n// Data Fetching     //\n///////////////////////\nconst doesKeyExist = rawKey => {\n  var rulesURL = options.rulesURL;\n  const Key = rawKey.replace(/^\\/+([^\\/])/, '$1');\n  logger('doesKeyExist: ', {\n    Key,\n    Bucket: options.originBucket\n  });\n  const cacheKey = `doesKeyExist_${options.rulesBucket}_${Key}`;\n\n  if (rulesURL == \"\") {\n    return cache.get(cacheKey, () => S3.headObject({\n      Bucket: options.originBucket,\n      Key\n    }).promise().then(data => {\n      logger('doesKeyExist FOUND: ', Key);\n      return true;\n    }).catch(err => {\n      if (err.errorType === 'NoSuchKey' || err.code === 'NotFound') {\n        logger('doesKeyExist NOT Found: ', Key);\n        return false;\n      }\n\n      logger('doesKeyExist err: ', err);\n      return false;\n    }));\n  } else {\n    rulesURL = \"https://\" + rulesURL + \"/\" + Key;\n    return cache.get(cacheKey, () => axios.default.get(rulesURL).then(data => {\n      console.logger('doesURLKeyExist FOUND: ', Key);\n      return true;\n    }).catch(err => {\n      if (err.errorType === 'NoSuchKey' || err.code === 'NotFound') {\n        logger('doesURLKeyExist NOT Found: ', Key);\n        return false;\n      }\n\n      logger('doesURLKeyExist err: ', err);\n      return false;\n    }));\n  }\n};\n\nconst getRedirectData = () => {\n  var rulesURL = options.rulesURL;\n  const Key = !options.multiFile ? options.file : `${options.file}_${options.host}`;\n  const cacheKey = `getRedirectData_${options.rulesBucket}_${Key}`;\n\n  if (rulesURL == \"\") {\n    return cache.get(cacheKey, () => {\n      logger(`\n        Getting Rules from: ${options.rules ? 'Options' : 'S3'}\n        Bucket: ${options.rulesBucket}\n        Key: ${Key}`);\n      return !!options.rules ? Promise.resolve(parseRules(options.rules)) : S3.getObject({\n        Bucket: options.rulesBucket,\n        Key\n      }).promise().then(data => parseRules(data.Body.toString())).catch(err => {\n        logger('No _redirects file', err);\n        return false;\n      });\n    });\n  } else {\n    return cache.get(cacheKey, () => {\n      logger(`\n        Getting Rules from: ${rulesURL}\n        Key: ${Key}`);\n      rulesURL = \"https://\" + rulesURL + \"/\" + Key;\n      return !!options.rules ? Promise.resolve(parseRules(options.rules)) : axios.default.get(rulesURL).then(response => parseRules(response.data.toString())).catch(err => {\n        logger('No _redirects file', err);\n        return false;\n      });\n    });\n  }\n};\n\nconst getProxyResponse = (resp) => {\n  const { status, statusText: statusDescription, data } = resp;\n  logger('getProxyResponse raw headers: ', resp.headers);\n  const headers = _omitBy(\n    _reduce(\n      resp.headers,\n      (result, value, key) => ({\n        ...result,\n        [key]: [\n          {\n            key: capitalizeParam(key),\n            value: resp.headers[key],\n          },\n        ],\n      }),\n      {},\n    ),\n    (value, key) => isBlacklistedProperty(value[0].key),\n  );\n  logger('getProxyResponse parse headers: ', headers);\n  const response = {\n    status,\n    statusDescription,\n    headers,\n    body: data.toString('base64'),\n    bodyEncoding: 'base64',\n  };\n  return response;\n};\n\nconst get404Response = () => {\n  var rulesURL = options.rulesURL;\n  const Key = options.custom404;\n  const cacheKey = `get404Response_${options.rulesBucket}_${Key}`;\n\n  if (rulesURL == \"\") {\n    return cache.get(cacheKey, () => S3.getObject({\n      Bucket: options.originBucket,\n      Key\n    }).promise().then(({\n      Body\n    }) => {\n      logger('Custom 404 FOUND');\n      return {\n        status: '404',\n        statusDescription: http.STATUS_CODES['404'],\n        headers: {\n          'content-type': [{\n            key: 'Content-Type',\n            value: 'text/html'\n          }]\n        },\n        body: Body.toString()\n      };\n    }).catch(err => {\n      if (err.errorType === 'NoSuchKey') {\n        logger('Custom 404 NOT Found');\n      }\n\n      logger('Get404ResponseErr', err);\n      return false;\n    }));\n  } else {\n    rulesURL = \"https://\" + rulesURL + \"/\" + Key;\n    return cache.get(cacheKey, () => axios.default.get(rulesURL).then(({\n      response\n    }) => {\n      logger('Custom 404 FOUND');\n      return {\n        status: '404',\n        statusDescription: http.STATUS_CODES['404'],\n        headers: {\n          'content-type': [{\n            key: 'Content-Type',\n            value: 'text/html'\n          }]\n        },\n        body: response.data.toString()\n      };\n    }).catch(err => {\n      if (err.errorType === 'NoSuchKey') {\n        logger('Custom 404 NOT Found');\n      }\n\n      logger('Get404ResponseErr', err);\n      return false;\n    }));\n  }\n};\n\n///////////////////////////\n// Event Generators     //\n//////////////////////////\nconst redirect = (to, status) => {\n  logger('Redirecting: ', to, status);\n  return {\n    status,\n    statusDescription: STATUS_CODES[status],\n    headers: {\n      location: [{ key: 'Location', value: to }],\n    },\n  };\n};\n\nconst rewrite = async (to, host, event) => {\n  logger('Rewriting: ', to);\n  const resp =\n    (!isAbsoluteURI(to) &&\n      !(await doesKeyExist(to)) &&\n      (await get404Response())) ||\n    merge(event, {\n      Records: [\n        {\n          cf: {\n            request: {\n              headers: { host: [{ key: 'Host', value: host }] },\n              uri: to,\n            },\n          },\n        },\n      ],\n    });\n  logger('Rewriting Event: ', JSON.stringify(resp));\n  return resp;\n};\n\nconst proxy = (url, event) => {\n  logger('PROXY start: ', url);\n  const { request } = event.Records[0].cf;\n  const config = {\n    ...lambdaReponseToObj(request),\n    url,\n    validateStatus: null,\n    maxContentLength: 8000000,\n    responseType: 'arraybuffer',\n  };\n  logger('PROXY config: ', config);\n  return axios(config)\n    .then((resp) => {\n      logger('PROXY data: ', _omit(resp, ['request', 'config']));\n      return getProxyResponse(resp);\n    })\n    .catch((err) => {\n      logger('PROXY err: ', err);\n      throw err;\n    });\n};\n\nexport default (opts) => ({\n  before: rerouteMiddleware.bind(null, opts),\n});\n","import dotProp from 'dot-prop-immutable';\nimport logger from './utils/logger';\nimport CacheService from './utils/cache-service';\nimport merge from './utils/deepmerge';\nimport AWS from 'aws-sdk';\n\nconst S3_SUFFIX = '.s3.amazonaws.com';\nconst ORIGIN_S3_DOTPATH = 'Records.0.cf.request.origin.s3';\n\nconst ttl = 300; // default TTL of 30 seconds\nconst cache = new CacheService(ttl);\n\nlet DDB;\nconst rerouteOrigin = async (opts = {}, handler, next) => {\n  const { context } = handler;\n  const { request } = handler.event.Records[0].cf;\n  const { origin } = request;\n  const [host] = getHeaderValues(['host'], request.headers);\n  const s3DomainName = origin && origin.s3 && origin.s3.domainName;\n  const originBucket = s3DomainName && s3DomainName.replace(S3_SUFFIX, '');\n\n  const tableSuffix = '-domainmap';\n  const functionSuffix = '-originrequest';\n  const defaults = {\n    functionSuffix,\n    tableSuffix,\n    tableName: getTableFromFunctionName(\n      context.functionName,\n      opts.functionSuffix || functionSuffix,\n      opts.tableSuffix || tableSuffix,\n    ),\n    cacheTtl: ttl,\n  };\n  const options = merge(defaults, opts);\n  cache.setDefaultTtl(options.cacheTtl);\n\n  DDB =\n    DDB ||\n    new AWS.DynamoDB({\n      apiVersion: '2012-08-10',\n      region: 'us-east-1',\n    });\n\n  logger(`\n    Raw Event:\n    ${JSON.stringify(handler.event)}\n\n    Middleware Options:\n    ${JSON.stringify(options)}\n    ---- Request ----\n    URI: ${request.uri}\n    Host: ${host}\n    Origin: ${s3DomainName}\n    `);\n\n  try {\n    const domainData = await getDomainData(options.tableName, host);\n    logger({ domainData });\n    handler.event = !!domainData\n      ? dotProp.merge(handler.event, ORIGIN_S3_DOTPATH, {\n          region: domainData.region,\n          domainName: domainData.origin,\n        })\n      : handler.event;\n  } catch (err) {\n    logger('Throwing Error for main thread');\n    throw err;\n  }\n\n  return;\n};\n\nexport default (opts) => ({\n  before: rerouteOrigin.bind(null, opts),\n});\n\n///////////////////////\n// Utils     //\n///////////////////////\nconst getHeaderValues = (paramArr, headers) =>\n  paramArr.map(\n    (param) => headers[param] && headers[param][0] && headers[param][0].value,\n  );\n\n// from:  us-east-1.myproject-prod-originrequest\n// to:    myproject-prod-domainmap\nconst getTableFromFunctionName = (\n  functionName,\n  functionSuffix,\n  tableSuffix,\n) => {\n  logger(`\n  getTableFromFunctionName:\n  ${JSON.stringify({ functionName, functionSuffix, tableSuffix })}\n  `);\n  const [rest, stackname] =\n    functionName.match(`^(?:us-east-1\\.)?(.+)${functionSuffix}$`) || [];\n  return `${stackname}${tableSuffix}`;\n};\n\nconst getDomainData = (table, host) =>\n  cache.get(`getDomainData_${host}`, () =>\n    DDB.getItem({\n      Key: {\n        Host: {\n          S: host,\n        },\n      },\n      TableName: table,\n    })\n      .promise()\n      .then((data) => {\n        logger(`\n      getDomainData: \n      ${JSON.stringify(data)}`);\n        return (\n          data.Item &&\n          data.Item.Origin &&\n          data.Item.Origin.S && {\n            host: data.Item.Host.S,\n            origin: data.Item.Origin.S,\n            region: (data.Item.Region && data.Item.Region.S) || 'us-east-1',\n          }\n        );\n      }),\n  );\n"],"names":["log","debug","console","bind","deepmerge","x","y","arrayMerge","rest","merge","combineMerge","all","arr","emptyTarget","value","Array","isArray","clone","options","target","source","destination","slice","forEach","e","i","cloneRequested","shouldClone","isMergeableObject","indexOf","push","Cache","constructor","ttlSeconds","cache","NodeCache","stdTTL","checkperiod","useClones","ttl","get","key","storeFunction","Promise","resolve","then","result","set","del","keys","setDefaultTtl","flush","delStartWith","startStr","flushAll","CacheService","axios","interceptors","response","use","error","reject","route","pathMatch","sensitive","strict","end","S3","rerouteMiddleware","opts","handler","next","request","event","Records","cf","origin","getHeaderValues","headers","host","country","language","userAgent","s3DomainName","s3","domainName","originBucket","replace","defaults","file","rules","undefined","multiFile","rulesBucket","rulesURL","regex","htmlEnd","ignoreRules","ruleline","absoluteUri","defaultStatus","redirectStatuses","friendlyUrls","defaultDoc","custom404","cacheTtl","incomingProtocol","s3Options","httpOptions","connectTimeout","mergeAll","AWS","logger","JSON","stringify","uri","Error","keyExists","doesKeyExist","isUnFriendlyUrl","match","first","fullpath","filename","isIndex","finalKey","redirect","data","getRedirectData","findMatch","parsedTo","isRedirectURI","status","isAbsoluteURI","proxy","rewrite","forceDefaultDoc","err","paramArr","map","param","includes","to","test","capitalizeParam","split","charAt","toUpperCase","join","path","extname","lambdaReponseToObj","req","method","body","_omit","_reduce","blacklistedHeaders","exact","startsWith","isBlacklistedProperty","name","find","replacePlaceholders","obj","pattern","_","k","replaceSplats","replaceAll","parseConditions","conditions","reduce","results","unused","toLowerCase","parseRules","stringFile","filter","l","from","force","parseInt","countryParser","supportedCountryArray","acceptCountryHeader","c","userAgentParser","testuserAgentArray","userAgentHeader","UAParser","browser","version","_find","uaRule","browserRule","versionRule","cleanVersion","semver","valid","coerce","isVersion","satisfies","isBrowser","isMatch","protocol","params","fullUri","o","parse","pathname","languagePass","langParser","pick","loose","countryPass","agentPass","useragent","passesConditions","rawKey","Key","Bucket","cacheKey","headObject","promise","catch","errorType","code","default","getObject","Body","toString","getProxyResponse","resp","statusDescription","statusText","_omitBy","bodyEncoding","get404Response","http","STATUS_CODES","location","url","config","validateStatus","maxContentLength","responseType","before","S3_SUFFIX","ORIGIN_S3_DOTPATH","DDB","rerouteOrigin","context","tableSuffix","functionSuffix","tableName","getTableFromFunctionName","functionName","DynamoDB","apiVersion","region","domainData","getDomainData","dotProp","stackname","table","getItem","Host","S","TableName","Item","Origin","Region"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,MAAMA,GAAG,GAAGC,yBAAK,CAAC,aAAD,CAAjB;AACAD,GAAG,CAACA,GAAJ,GAAUE,OAAO,CAACF,GAAR,CAAYG,IAAZ,CAAiBD,OAAjB,CAAV;;ACAA,MAAME,SAAS,GAAG,CAACC,CAAD,EAAIC,CAAJ,EAAO,OAA0B,EAAjC;AAAA,MAASC,UAAT,QAASA,UAAT;AAAA,MAAwBC,IAAxB;;AAAA,SAChBC,yBAAK,CAACJ,CAAD,EAAIC,CAAJ,oCAAYE,IAAZ;AAAkBD,IAAAA,UAAU,EAAEG;AAA9B,KADW;AAAA,CAAlB;;AAGA,MAAMC,GAAG,GAAG,CAACC,GAAD,EAAM,QAA0B,EAAhC;AAAA,MAAQL,UAAR,SAAQA,UAAR;AAAA,MAAuBC,IAAvB;;AAAA,SACVC,yBAAK,CAACE,GAAN,CAAUC,GAAV,oCAAoBJ,IAApB;AAA0BD,IAAAA,UAAU,EAAEG;AAAtC,KADU;AAAA,CAAZ;;AAGA,MAAMG,WAAW,GAAIC,KAAD,IAAYC,KAAK,CAACC,OAAN,CAAcF,KAAd,IAAuB,EAAvB,GAA4B,EAA5D;;AACA,MAAMG,KAAK,GAAG,CAACH,KAAD,EAAQI,OAAR,KAAoBT,yBAAK,CAACI,WAAW,CAACC,KAAD,CAAZ,EAAqBA,KAArB,EAA4BI,OAA5B,CAAvC;;AACA,MAAMR,YAAY,GAAG,CAACS,MAAD,EAASC,MAAT,EAAiBF,OAAjB,KAA6B;AAChD,QAAMG,WAAW,GAAGF,MAAM,CAACG,KAAP,EAApB;AACAF,EAAAA,MAAM,CAACG,OAAP,CAAe,CAACC,CAAD,EAAIC,CAAJ,KAAU;AACvB,QAAI,OAAOJ,WAAW,CAACI,CAAD,CAAlB,KAA0B,WAA9B,EAA2C;AACzC,YAAMC,cAAc,GAAGR,OAAO,CAACD,KAAR,KAAkB,KAAzC;AACA,YAAMU,WAAW,GAAGD,cAAc,IAAIR,OAAO,CAACU,iBAAR,CAA0BJ,CAA1B,CAAtC;AACAH,MAAAA,WAAW,CAACI,CAAD,CAAX,GAAiBE,WAAW,GAAGV,KAAK,CAACO,CAAD,EAAIN,OAAJ,CAAR,GAAuBM,CAAnD;AACD,KAJD,MAIO,IAAIN,OAAO,CAACU,iBAAR,CAA0BJ,CAA1B,CAAJ,EAAkC;AACvCH,MAAAA,WAAW,CAACI,CAAD,CAAX,GAAiBhB,yBAAK,CAACU,MAAM,CAACM,CAAD,CAAP,EAAYD,CAAZ,EAAeN,OAAf,CAAtB;AACD,KAFM,MAEA,IAAIC,MAAM,CAACU,OAAP,CAAeL,CAAf,MAAsB,CAAC,CAA3B,EAA8B;AACnCH,MAAAA,WAAW,CAACS,IAAZ,CAAiBN,CAAjB;AACD;AACF,GAVD;AAWA,SAAOH,WAAP;AACD,CAdD;;ACRA,MAAMU,KAAN,CAAY;AACVC,EAAAA,WAAW,CAACC,UAAD,EAAa;AACtB,SAAKC,KAAL,GAAa,IAAIC,6BAAJ,CAAc;AACzBC,MAAAA,MAAM,EAAEH,UADiB;AAEzBI,MAAAA,WAAW,EAAEJ,UAAU,GAAG,GAFD;AAGzBK,MAAAA,SAAS,EAAE;AAHc,KAAd,CAAb;AAMA,SAAKC,GAAL,GAAWN,UAAX;AACD;;AAEDO,EAAAA,GAAG,CAACC,GAAD,EAAMC,aAAN,EAAqB;AACtB,QAAI,KAAKH,GAAL,GAAW,CAAf,EAAkB;AAChB,YAAMzB,KAAK,GAAG,KAAKoB,KAAL,CAAWM,GAAX,CAAeC,GAAf,CAAd;;AACA,UAAI3B,KAAJ,EAAW;AACT,eAAO6B,OAAO,CAACC,OAAR,CAAgB9B,KAAhB,CAAP;AACD;AACF;;AACD,WAAO4B,aAAa,GAAGG,IAAhB,CAAsBC,MAAD,IAAY;AACtC,WAAKP,GAAL,GAAW,CAAX,IAAgB,KAAKL,KAAL,CAAWa,GAAX,CAAeN,GAAf,EAAoBK,MAApB,EAA4B,KAAKP,GAAjC,CAAhB;AACA,aAAOO,MAAP;AACD,KAHM,CAAP;AAID;;AAEDE,EAAAA,GAAG,CAACC,IAAD,EAAO;AACR,SAAKf,KAAL,CAAWc,GAAX,CAAeC,IAAf;AACD;;AAEDC,EAAAA,aAAa,CAACX,GAAD,EAAM;AACjB,SAAKA,GAAL,GAAWA,GAAX;AACA,SAAKA,GAAL,KAAa,CAAb,IAAkB,KAAKY,KAAL,EAAlB;AACD;;AAEDC,EAAAA,YAAY,CAACC,QAAQ,GAAG,EAAZ,EAAgB;AAC1B,QAAI,CAACA,QAAL,EAAe;AACb;AACD;;AAED,UAAMJ,IAAI,GAAG,KAAKf,KAAL,CAAWe,IAAX,EAAb;;AAL0B,+CAMRA,IANQ;AAAA;;AAAA;AAM1B,0DAAwB;AAAA,cAAbR,GAAa;;AACtB,YAAIA,GAAG,CAACZ,OAAJ,CAAYwB,QAAZ,MAA0B,CAA9B,EAAiC;AAC/B,eAAKL,GAAL,CAASP,GAAT;AACD;AACF;AAVyB;AAAA;AAAA;AAAA;AAAA;AAW3B;;AAEDU,EAAAA,KAAK,GAAG;AACN,SAAKjB,KAAL,CAAWoB,QAAX;AACD;;AAhDS;;ACeZ,MAAMf,GAAG,GAAG,GAAZ;;AACA,MAAML,KAAK,GAAG,IAAIqB,KAAJ,CAAiBhB,GAAjB,CAAd;AAEAiB,yBAAK,CAACC,YAAN,CAAmBC,QAAnB,CAA4BC,GAA5B,CACE,UAAUD,QAAV,EAAoB;AAClB;AACA,SAAOA,QAAP;AACD,CAJH,EAKE,UAAUE,KAAV,EAAiB;AACf;AACA,SAAOjB,OAAO,CAACkB,MAAR,CAAeD,KAAf,CAAP;AACD,CARH;AAWA,MAAME,KAAK,GAAGC,6BAAS,CAAC;AACtBC,EAAAA,SAAS,EAAE,KADW;AAEtBC,EAAAA,MAAM,EAAE,KAFc;AAGtBC,EAAAA,GAAG,EAAE;AAHiB,CAAD,CAAvB;AAMA,IAAIhD,OAAJ,EAAaiD,EAAb;;AACA,MAAMC,iBAAiB;AAAA,+BAAG,WAAOC,IAAI,GAAG,EAAd,EAAkBC,OAAlB,EAA2BC,IAA3B,EAAoC;AAAA,UACpDC,OADoD,GACxCF,OAAO,CAACG,KAAR,CAAcC,OAAd,CAAsB,CAAtB,EAAyBC,EADe,CACpDH,OADoD;AAAA,UAEpDI,MAFoD,GAEzCJ,OAFyC,CAEpDI,MAFoD;;AAAA,6BAGfC,eAAe,CAC1D,CAAC,MAAD,EAAS,2BAAT,EAAsC,iBAAtC,EAAyD,YAAzD,CAD0D,EAE1DL,OAAO,CAACM,OAFkD,CAHA;AAAA;AAAA,UAGrDC,IAHqD;AAAA,UAG/CC,OAH+C;AAAA,UAGtCC,QAHsC;AAAA,UAG5BC,SAH4B;;AAO5D,UAAMC,YAAY,GAAGP,MAAM,IAAIA,MAAM,CAACQ,EAAjB,IAAuBR,MAAM,CAACQ,EAAP,CAAUC,UAAtD;AACA,UAAMC,YAAY,GAChBH,YAAY,IAAIA,YAAY,CAACI,OAAb,CAAqB,mBAArB,EAA0C,EAA1C,CADlB;AAEA,UAAMC,QAAQ,GAAG;AACfC,MAAAA,IAAI,EAAE,YADS;AAEfC,MAAAA,KAAK,EAAEC,SAFQ;AAGfC,MAAAA,SAAS,EAAE,KAHI;AAIfC,MAAAA,WAAW,EAAE,cAJE;AAKfC,MAAAA,QAAQ,EAAE,EALK;AAMfC,MAAAA,KAAK,EAAE;AACLC,QAAAA,OAAO,EAAE,sBADJ;AAELC,QAAAA,WAAW,EAAE,yCAFR;AAGLC,QAAAA,QAAQ,EAAE,6EAHL;AAILC,QAAAA,WAAW,EAAE;AAJR,OANQ;AAYfC,MAAAA,aAAa,EAAE,GAZA;AAafC,MAAAA,gBAAgB,EAAE,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,CAbH;AAcfC,MAAAA,YAAY,EAAE,IAdC;AAefC,MAAAA,UAAU,EAAG,YAfE;AAgBfC,MAAAA,SAAS,EAAG,UAhBG;AAiBfC,MAAAA,QAAQ,EAAElE,GAjBK;AAkBfmE,MAAAA,gBAAgB,EAAE,UAlBH;AAmBfC,MAAAA,SAAS,EAAE;AAAEC,QAAAA,WAAW,EAAE;AAAEC,UAAAA,cAAc,EAAE;AAAlB;AAAf,OAnBI;;AAAA,KAAjB;AAqBA3F,IAAAA,OAAO,GAAG4F,GAAQ,CAAC,CACjBtB,QADiB,EAEjBnB,IAFiB,EAGjB;AACEiB,MAAAA,YADF;AAEEP,MAAAA,IAFF;AAGEC,MAAAA,OAHF;AAIEC,MAAAA,QAJF;AAKEC,MAAAA;AALF,KAHiB,CAAD,CAAlB;AAWAhD,IAAAA,KAAK,CAACgB,aAAN,CAAoBhC,OAAO,CAACuF,QAA5B;AAEAtC,IAAAA,EAAE,GAAGA,EAAE,IAAI,IAAI4C,uBAAG,CAAC5C,EAAR,CAAWjD,OAAO,CAACyF,SAAnB,CAAX;AAEAK,IAAAA,GAAM,CAAE;AACV;AACA,MAAMC,IAAI,CAACC,SAAL,CAAe5C,OAAO,CAACG,KAAvB,CAA8B;AACpC;AACA;AACA,MAAMwC,IAAI,CAACC,SAAL,CAAehG,OAAf,CAAwB;AAC9B;AACA,WAAWsD,OAAO,CAAC2C,GAAI;AACvB,YAAYjG,OAAO,CAAC6D,IAAK;AACzB,cAAcI,YAAa;AAC3B,eAAejE,OAAO,CAAC8D,OAAQ;AAC/B,gBAAgB9D,OAAO,CAAC+D,QAAS;AACjC,iBAAiB/D,OAAO,CAACgE,SAAU;AACnC,KAbQ,CAAN,CA9C4D;;AA8D5D,QAAI,CAACC,YAAL,EAAmB,MAAM,IAAIiC,KAAJ,CAAU,uBAAV,CAAN;;AAEnB,QAAI;AACF;AACA,YAAMC,SAAS,SAASC,YAAY,CAAC9C,OAAO,CAAC2C,GAAT,CAApC,CAFE;;AAKF,YAAMI,eAAe,GACnBrG,OAAO,CAACoF,YAAR,IAAwB9B,OAAO,CAAC2C,GAAR,CAAYK,KAAZ,CAAkBtG,OAAO,CAAC6E,KAAR,CAAcC,OAAhC,CAD1B;;AALE,oBAQwCuB,eAAe,IAAI,EAR3D;AAAA;AAAA,YAQKE,KARL;AAAA,YAQYC,QARZ;AAAA,YAQsBjC,IARtB;AAAA,YAQ4BkC,QAR5B;;AASF,YAAMC,OAAO,GAAGD,QAAQ,KAAK,OAA7B;AAEA,UAAIlD,KAAJ,CAXE;AAaF;;AACA,UAAI8C,eAAe,KAAK,CAACF,SAAD,IAAcO,OAAnB,CAAnB,EAAgD;AAC9C,cAAM1D,GAAG,GAAG0D,OAAO,GAAG,EAAH,GAAS,GAAED,QAAS,GAAvC;AACA,cAAME,QAAQ,GAAI,GAAEH,QAAS,IAAGxD,GAAI,EAApC;AACA8C,QAAAA,GAAM,CAAC,4BAAD,EAA+BxC,OAAO,CAAC2C,GAAvC,EAA4CU,QAA5C,CAAN;AACApD,QAAAA,KAAK,GAAGqD,QAAQ,CAACD,QAAD,EAAW,GAAX,CAAhB;AACD,OALD,MAKO;AACL;AACA,cAAME,IAAI,SAASC,eAAe,EAAlC;AACAhB,QAAAA,GAAM,CAAC,SAAD,EAAYe,IAAZ,CAAN,CAHK;;AAML,cAAMP,KAAK,GAAGS,SAAS,CACrBF,IADqB,EAErBvD,OAAO,CAAC2C,GAFa,EAGrBpC,IAHqB,EAIrB7D,OAAO,CAACwF,gBAJa,CAAvB;;AAMA,YAAIc,KAAJ,EAAW;AACTR,UAAAA,GAAM,CAAC,eAAD,EAAkBQ,KAAK,CAACU,QAAxB,CAAN,CADS;AAGT;;AACAzD,UAAAA,KAAK,GAAG0D,aAAa,CAACX,KAAK,CAACY,MAAP,CAAb,GACJN,QAAQ,CAACN,KAAK,CAACU,QAAP,EAAiBV,KAAK,CAACY,MAAvB,CADJ,GAEJC,aAAa,CAACb,KAAK,CAACU,QAAP,CAAb,SACMI,KAAK,CAACd,KAAK,CAACU,QAAP,EAAiB5D,OAAO,CAACG,KAAzB,CADX,SAEM8D,OAAO,CACXC,eAAe,CAAChB,KAAK,CAACU,QAAP,CADJ,EAEX/C,YAFW,EAGXb,OAAO,CAACG,KAHG,CAJjB;AASD,SAbD,MAaO;AACLuC,UAAAA,GAAM,CAAC,UAAD,CAAN,CADK;;AAGLvC,UAAAA,KAAK,SAAS8D,OAAO,CACnBC,eAAe,CAAChE,OAAO,CAAC2C,GAAT,CADI,EAEnBhC,YAFmB,EAGnBb,OAAO,CAACG,KAHW,CAArB;AAKD;AACF;;AAEDH,MAAAA,OAAO,CAACG,KAAR,GAAgBA,KAAhB;AACD,KAxDD,CAwDE,OAAOgE,GAAP,EAAY;AACZzB,MAAAA,GAAM,CAAC,gCAAD,CAAN;AACA,YAAMyB,GAAN;AACD;;AAEDzB,IAAAA,GAAM,CAAC,qBAAD,EAAwB1C,OAAO,CAACG,KAAhC,CAAN;AACA;AACD,GA/HsB;;AAAA,kBAAjBL,iBAAiB;AAAA;AAAA;AAAA,GAAvB;AAkIA;AACA;;;AACA,MAAMS,eAAe,GAAG,CAAC6D,QAAD,EAAW5D,OAAX,KACtB4D,QAAQ,CAACC,GAAT,CACGC,KAAD,IAAW9D,OAAO,CAAC8D,KAAD,CAAP,IAAkB9D,OAAO,CAAC8D,KAAD,CAAP,CAAe,CAAf,CAAlB,IAAuC9D,OAAO,CAAC8D,KAAD,CAAP,CAAe,CAAf,EAAkB9H,KADtE,CADF;;AAIA,MAAMqH,aAAa,GAAIC,MAAD,IAAYlH,OAAO,CAACmF,gBAAR,CAAyBwC,QAAzB,CAAkCT,MAAlC,CAAlC;;AAEA,MAAMC,aAAa,GAAIS,EAAD,IAAQ;AAC5B,QAAMC,IAAI,GAAG7H,OAAO,CAAC6E,KAAR,CAAcI,WAAd,CAA0B4C,IAA1B,CAA+BD,EAA/B,CAAb;AACA9B,EAAAA,GAAM,CAAC,iBAAD,EAAoB+B,IAApB,EAA0BD,EAA1B,CAAN;AACA,SAAOC,IAAP;AACD,CAJD;;AAMA,MAAMC,eAAe,GAAIJ,KAAD,IACtBA,KAAK,CACFK,KADH,CACS,GADT,EAEGN,GAFH,CAEQlH,CAAD,IAAOA,CAAC,CAACyH,MAAF,CAAS,CAAT,EAAYC,WAAZ,KAA4B1H,CAAC,CAACH,KAAF,CAAQ,CAAR,CAF1C,EAGG8H,IAHH,CAGQ,GAHR,CADF;;AAMA,MAAMZ,eAAe,GAAIrB,GAAD,IACtBkC,wBAAI,CAACC,OAAL,CAAanC,GAAb,MAAsB,EAAtB,IAA4B,CAAC,CAACjG,OAAO,CAACqF,UAAtC,GACI8C,wBAAI,CAACD,IAAL,CAAUjC,GAAV,EAAejG,OAAO,CAACqF,UAAvB,CADJ,GAEIY,GAHN;;AAKA,MAAMoC,kBAAkB,GAAIC,GAAD,IAAS;AAAA,QAC1BC,MAD0B,GACTD,GADS,CAC1BC,MAD0B;AAAA,QAClBC,IADkB,GACTF,GADS,CAClBE,IADkB;AAElC,SAAO;AACLD,IAAAA,MADK;AAEL3E,IAAAA,OAAO,EAAE6E,yBAAK,CACZC,2BAAO,CACLJ,GAAG,CAAC1E,OADC,EAEL,CAAChC,MAAD,EAAShC,KAAT,EAAgB2B,GAAhB,uCAA8BK,MAA9B;AAAsC,OAAChC,KAAK,CAAC,CAAD,CAAL,CAAS2B,GAAV,GAAgB3B,KAAK,CAAC,CAAD,CAAL,CAASA;AAA/D,MAFK,EAGL,EAHK,CADK,EAMZ,CAAC,MAAD,CANY;AAFT,GAAP;AAWD,CAbD;;AAeA,MAAM+I,kBAAkB,GAAG;AACzBC,EAAAA,KAAK,EAAE,CACL,YADK,EAEL,QAFK,EAGL,YAHK,EAIL,oBAJK,EAKL,qBALK,EAML,kBANK,EAOL,SAPK,EAQL,SARK,EASL,mBATK,EAUL,iBAVK,EAWL,oBAXK,EAYL,kBAZK,EAaL,SAbK,EAcL,mBAdK,EAeL,WAfK,EAgBL,iBAhBK,EAiBL,gBAjBK,EAkBL,mBAlBK,EAmBL,eAnBK,EAoBL,UApBK,EAqBL,qBArBK,EAsBL,OAtBK,EAuBL,mBAvBK,EAwBL,KAxBK,CADkB;AA2BzBC,EAAAA,UAAU,EAAE,CAAC,SAAD,EAAY,WAAZ,EAAyB,SAAzB;AA3Ba,CAA3B;;AA6BA,MAAMC,qBAAqB,GAAIC,IAAD,IAC5BJ,kBAAkB,CAACC,KAAnB,CAAyBjB,QAAzB,CAAkCoB,IAAlC,KACA,CAAC,CAACJ,kBAAkB,CAACE,UAAnB,CAA8BG,IAA9B,CAAoCzI,CAAD,IAAOwI,IAAI,CAACF,UAAL,CAAgBtI,CAAhB,CAA1C,CAFJ;AAKA;AACA;;;AACA,MAAM0I,mBAAmB,GAAG,CAACC,GAAD,EAAMC,OAAN,KAC1BA,OAAO,CAAC9E,OAAR,CAAgB,kBAAhB,EAAoC,CAAC+E,CAAD,EAAIC,CAAJ,KAAUH,GAAG,CAACG,CAAD,CAAjD,CADF;;AAGA,MAAMC,aAAa,GAAG,CAACJ,GAAD,EAAMC,OAAN,KACpBT,2BAAO,CACLQ,GADK,EAEL,CAACtH,MAAD,EAAShC,KAAT,EAAgB2B,GAAhB,KAAwBK,MAAM,CAACyC,OAAP,CAAe,WAAf,EAA4B6E,GAAG,CAAC3H,GAAD,CAA/B,CAFnB,EAGL4H,OAHK,CAAP,CAIE9E,OAJF,CAIU,WAJV,EAIuB,EAJvB,CADF;;AAOA,MAAMkF,UAAU,GAAG,CAACL,GAAD,EAAMC,OAAN,KACjBG,aAAa,CAACJ,GAAD,EAAMD,mBAAmB,CAACC,GAAD,EAAMC,OAAN,CAAzB,CADf;;AAGA,MAAMK,eAAe,GAAIC,UAAD,IACtB,CAAC,CAACA,UAAF,GACIA,UAAU,CAAC1B,KAAX,CAAiB,GAAjB,EAAsB2B,MAAtB,CAA6B,CAACC,OAAD,EAAUtG,IAAV,KAAmB;AAAA,sBACjBA,IAAI,CAAC0E,KAAL,CAAW,cAAX,CADiB;AAAA;AAAA,QACvC6B,MADuC;AAAA,QAC/BrI,GAD+B;AAAA,QAC1B3B,KAD0B;;AAE9C,2CAAY+J,OAAZ;AAAqB,KAACpI,GAAG,CAACsI,WAAJ,EAAD,GAAqBjK,KAAK,CAACmI,KAAN,CAAY,GAAZ;AAA1C;AACD,CAHD,EAGG,EAHH,CADJ,GAKI,EANN;;AAQA,MAAM+B,UAAU,GAAIC,UAAD,IAAgB;AACjCjE,EAAAA,GAAM,CAAC,kBAAD,EAAqBiE,UAArB,CAAN;AACA,SACEA,UAAU;AAAA,GAEP1F,OAFH,CAEWrE,OAAO,CAAC6E,KAAR,CAAcE,WAFzB,EAEsC,EAFtC;AAAA,GAIGgD,KAJH,CAIS,UAJT;AAAA,GAMGiC,MANH,CAMWC,CAAD,IAAOA,CAAC,KAAK,EANvB,EAOGxC,GAPH,CAOQwC,CAAD,IAAO;AACV;AADU,qBAE2CA,CAAC,CAAC3D,KAAF,CACnDtG,OAAO,CAAC6E,KAAR,CAAcG,QADqC,CAF3C;AAAA;AAAA,UAEHuB,KAFG;AAAA,UAEI2D,IAFJ;AAAA,UAEUtC,EAFV;AAAA,UAEcV,MAFd;AAAA,UAEsBiD,KAFtB;AAAA,UAE6BV,UAF7B;;;AAMV,WAAO;AACLS,MAAAA,IADK;AAELtC,MAAAA,EAFK;AAGLV,MAAAA,MAAM,EAAEA,MAAM,GAAGkD,QAAQ,CAAClD,MAAD,EAAS,EAAT,CAAX,GAA0BlH,OAAO,CAACkF,aAH3C;AAILiF,MAAAA,KAAK,EAAE,CAAC,CAACA,KAJJ;AAKLV,MAAAA,UAAU,EAAED,eAAe,CAACC,UAAD;AALtB,KAAP;AAOD,GApBH,CADF;AAuBD,CAzBD;;AA2BA,MAAMY,aAAa,GAAG,CAACC,qBAAD,EAAwBC,mBAAxB,KACpBD,qBAAqB,CAClB7C,GADH,CACQ+C,CAAD,IAAOA,CAAC,CAACX,WAAF,EADd,EAEGlC,QAFH,CAEY4C,mBAAmB,CAACV,WAApB,EAFZ,CADF;;AAKA,MAAMY,eAAe,GAAG,CAACC,kBAAD,EAAqBC,eAArB,KAAyC;AAAA,4BAC5BC,4BAAQ,CAACD,eAAD,CAAR,CAA0BE,OADE;AAAA,QACjDA,OADiD,qBACvD9B,IADuD;AAAA,QACxC+B,OADwC,qBACxCA,OADwC;;AAE/D,QAAMxE,KAAK,GAAGyE,yBAAK,CAACL,kBAAD,EAAsBM,MAAD,IAAY;AAAA,0BACfA,MAAM,CAACjD,KAAP,CAAa,GAAb,CADe;AAAA;AAAA,UAC3CkD,WAD2C;AAAA,UAC9BC,WAD8B;;AAElD,UAAMC,YAAY,GAAGC,0BAAM,CAACC,KAAP,CAAaD,0BAAM,CAACE,MAAP,CAAcR,OAAd,CAAb,CAArB;AACA,UAAMS,SAAS,GAAGH,0BAAM,CAACI,SAAP,CAAiBL,YAAjB,EAA+BD,WAA/B,CAAlB;AACA,UAAMO,SAAS,GAAGZ,OAAO,KAAKI,WAA9B;AACA,UAAMS,OAAO,GAAGD,SAAS,IAAIF,SAA7B;AACA,WAAOG,OAAP;AACD,GAPkB,CAAnB;;AAQA,SAAO,CAAC,CAACpF,KAAT;AACD,CAXD;;AAaA,MAAMS,SAAS,GAAG,CAACF,IAAD,EAAOsB,IAAP,EAAatE,IAAb,EAAmB8H,QAAnB,KAAgC;AAChD,MAAIC,MAAJ;AACA,QAAMC,OAAO,GAAGhI,IAAI,IAAK,GAAE8H,QAAS,GAAE9H,IAAK,GAAEsE,IAAK,EAAlD;;AACA,QAAM7B,KAAK,GAAGyE,yBAAK,CAAClE,IAAD,EAAQiF,CAAD,IAAO;AAC/B,UAAM5B,IAAI,GAAGtH,KAAK,CAACkJ,CAAC,CAAC5B,IAAH,CAAlB;AACA0B,IAAAA,MAAM,GAAGzE,aAAa,CAAC2E,CAAC,CAAC5B,IAAH,CAAb,GAAwBA,IAAI,CAAC2B,OAAD,CAA5B,GAAwC3B,IAAI,CAAC6B,SAAK,CAAC5D,IAAD,CAAL,CAAY6D,QAAb,CAArD,CAF+B;;AAK/B,UAAMC,YAAY,GAAG,CAAC,CAACH,CAAC,CAACrC,UAAF,CAAa1F,QAAf,GACjB,CAAC,CAAC/D,OAAO,CAAC+D,QAAV,IACA,CAAC,CAACmI,8BAAU,CAACC,IAAX,CAAgBL,CAAC,CAACrC,UAAF,CAAa1F,QAA7B,EAAuC/D,OAAO,CAAC+D,QAA/C,EAAyD;AACzDqI,MAAAA,KAAK,EAAE;AADkD,KAAzD,CAFe,GAKjB,IALJ,CAL+B;;AAa/B,UAAMC,WAAW,GAAG,CAAC,CAACP,CAAC,CAACrC,UAAF,CAAa3F,OAAf,GAChB,CAAC,CAAC9D,OAAO,CAAC8D,OAAV,IACAuG,aAAa,CAACyB,CAAC,CAACrC,UAAF,CAAa3F,OAAd,EAAuB9D,OAAO,CAAC8D,OAA/B,CAFG,GAGhB,IAHJ,CAb+B;;AAmB/B,UAAMwI,SAAS,GAAG,CAAC,CAACR,CAAC,CAACrC,UAAF,CAAa8C,SAAf,GACd,CAAC,CAACvM,OAAO,CAACgE,SAAV,IACAyG,eAAe,CAACqB,CAAC,CAACrC,UAAF,CAAa8C,SAAd,EAAyBvM,OAAO,CAACgE,SAAjC,CAFD,GAGd,IAHJ,CAnB+B;;AAyB/B,UAAMwI,gBAAgB,GAAGP,YAAY,IAAII,WAAhB,IAA+BC,SAAxD;AACA,WAAOV,MAAM,KAAK,KAAX,IAAoBY,gBAA3B;AACD,GA3BkB,CAAnB;;AA4BA,SAAOlG,KAAK,sCAASA,KAAT;AAAgBU,IAAAA,QAAQ,EAAEuC,UAAU,CAACqC,MAAD,EAAStF,KAAK,CAACsB,EAAf;AAApC,IAAZ;AACD,CAhCD;AAmCA;AACA;;;AACA,MAAMxB,YAAY,GAAGqG,MAAM,IAAI;AAC7B,MAAI7H,QAAQ,GAAG5E,OAAO,CAAC4E,QAAvB;AACA,QAAM8H,GAAG,GAAGD,MAAM,CAACpI,OAAP,CAAe,aAAf,EAA8B,IAA9B,CAAZ;AACAyB,EAAAA,GAAM,CAAC,gBAAD,EAAmB;AACvB4G,IAAAA,GADuB;AAEvBC,IAAAA,MAAM,EAAE3M,OAAO,CAACoE;AAFO,GAAnB,CAAN;AAIA,QAAMwI,QAAQ,GAAI,gBAAe5M,OAAO,CAAC2E,WAAY,IAAG+H,GAAI,EAA5D;;AAEA,MAAI9H,QAAQ,IAAI,EAAhB,EAAoB;AAClB,WAAO5D,KAAK,CAACM,GAAN,CAAUsL,QAAV,EAAoB,MAAM3J,EAAE,CAAC4J,UAAH,CAAc;AAC7CF,MAAAA,MAAM,EAAE3M,OAAO,CAACoE,YAD6B;AAE7CsI,MAAAA;AAF6C,KAAd,EAG9BI,OAH8B,GAGpBnL,IAHoB,CAGfkF,IAAI,IAAI;AACxBf,MAAAA,GAAM,CAAC,sBAAD,EAAyB4G,GAAzB,CAAN;AACA,aAAO,IAAP;AACD,KANgC,EAM9BK,KAN8B,CAMxBxF,GAAG,IAAI;AACd,UAAIA,GAAG,CAACyF,SAAJ,KAAkB,WAAlB,IAAiCzF,GAAG,CAAC0F,IAAJ,KAAa,UAAlD,EAA8D;AAC5DnH,QAAAA,GAAM,CAAC,0BAAD,EAA6B4G,GAA7B,CAAN;AACA,eAAO,KAAP;AACD;;AAED5G,MAAAA,GAAM,CAAC,oBAAD,EAAuByB,GAAvB,CAAN;AACA,aAAO,KAAP;AACD,KAdgC,CAA1B,CAAP;AAeD,GAhBD,MAgBO;AACL3C,IAAAA,QAAQ,GAAG,aAAaA,QAAb,GAAwB,GAAxB,GAA8B8H,GAAzC;AACA,WAAO1L,KAAK,CAACM,GAAN,CAAUsL,QAAV,EAAoB,MAAMtK,yBAAK,CAAC4K,OAAN,CAAc5L,GAAd,CAAkBsD,QAAlB,EAA4BjD,IAA5B,CAAiCkF,IAAI,IAAI;AACxE7H,MAAAA,OAAO,CAAC8G,MAAR,CAAe,yBAAf,EAA0C4G,GAA1C;AACA,aAAO,IAAP;AACD,KAHgC,EAG9BK,KAH8B,CAGxBxF,GAAG,IAAI;AACd,UAAIA,GAAG,CAACyF,SAAJ,KAAkB,WAAlB,IAAiCzF,GAAG,CAAC0F,IAAJ,KAAa,UAAlD,EAA8D;AAC5DnH,QAAAA,GAAM,CAAC,6BAAD,EAAgC4G,GAAhC,CAAN;AACA,eAAO,KAAP;AACD;;AAED5G,MAAAA,GAAM,CAAC,uBAAD,EAA0ByB,GAA1B,CAAN;AACA,aAAO,KAAP;AACD,KAXgC,CAA1B,CAAP;AAYD;AACF,CAxCD;;AA0CA,MAAMT,eAAe,GAAG,MAAM;AAC5B,MAAIlC,QAAQ,GAAG5E,OAAO,CAAC4E,QAAvB;AACA,QAAM8H,GAAG,GAAG,CAAC1M,OAAO,CAAC0E,SAAT,GAAqB1E,OAAO,CAACuE,IAA7B,GAAqC,GAAEvE,OAAO,CAACuE,IAAK,IAAGvE,OAAO,CAAC6D,IAAK,EAAhF;AACA,QAAM+I,QAAQ,GAAI,mBAAkB5M,OAAO,CAAC2E,WAAY,IAAG+H,GAAI,EAA/D;;AAEA,MAAI9H,QAAQ,IAAI,EAAhB,EAAoB;AAClB,WAAO5D,KAAK,CAACM,GAAN,CAAUsL,QAAV,EAAoB,MAAM;AAC/B9G,MAAAA,GAAM,CAAE;AACd,8BAA8B9F,OAAO,CAACwE,KAAR,GAAgB,SAAhB,GAA4B,IAAK;AAC/D,kBAAkBxE,OAAO,CAAC2E,WAAY;AACtC,eAAe+H,GAAI,EAHP,CAAN;AAIA,aAAO,CAAC,CAAC1M,OAAO,CAACwE,KAAV,GAAkB/C,OAAO,CAACC,OAAR,CAAgBoI,UAAU,CAAC9J,OAAO,CAACwE,KAAT,CAA1B,CAAlB,GAA+DvB,EAAE,CAACkK,SAAH,CAAa;AACjFR,QAAAA,MAAM,EAAE3M,OAAO,CAAC2E,WADiE;AAEjF+H,QAAAA;AAFiF,OAAb,EAGnEI,OAHmE,GAGzDnL,IAHyD,CAGpDkF,IAAI,IAAIiD,UAAU,CAACjD,IAAI,CAACuG,IAAL,CAAUC,QAAV,EAAD,CAHkC,EAGVN,KAHU,CAGJxF,GAAG,IAAI;AACvEzB,QAAAA,GAAM,CAAC,oBAAD,EAAuByB,GAAvB,CAAN;AACA,eAAO,KAAP;AACD,OANqE,CAAtE;AAOD,KAZM,CAAP;AAaD,GAdD,MAcO;AACL,WAAOvG,KAAK,CAACM,GAAN,CAAUsL,QAAV,EAAoB,MAAM;AAC/B9G,MAAAA,GAAM,CAAE;AACd,8BAA8BlB,QAAS;AACvC,eAAe8H,GAAI,EAFP,CAAN;AAGA9H,MAAAA,QAAQ,GAAG,aAAaA,QAAb,GAAwB,GAAxB,GAA8B8H,GAAzC;AACA,aAAO,CAAC,CAAC1M,OAAO,CAACwE,KAAV,GAAkB/C,OAAO,CAACC,OAAR,CAAgBoI,UAAU,CAAC9J,OAAO,CAACwE,KAAT,CAA1B,CAAlB,GAA+DlC,yBAAK,CAAC4K,OAAN,CAAc5L,GAAd,CAAkBsD,QAAlB,EAA4BjD,IAA5B,CAAiCa,QAAQ,IAAIsH,UAAU,CAACtH,QAAQ,CAACqE,IAAT,CAAcwG,QAAd,EAAD,CAAvD,EAAmFN,KAAnF,CAAyFxF,GAAG,IAAI;AACpKzB,QAAAA,GAAM,CAAC,oBAAD,EAAuByB,GAAvB,CAAN;AACA,eAAO,KAAP;AACD,OAHqE,CAAtE;AAID,KATM,CAAP;AAUD;AACF,CA/BD;;AAiCA,MAAM+F,gBAAgB,GAAIC,IAAD,IAAU;AAAA,QACzBrG,MADyB,GACuBqG,IADvB,CACzBrG,MADyB;AAAA,QACLsG,iBADK,GACuBD,IADvB,CACjBE,UADiB;AAAA,QACc5G,IADd,GACuB0G,IADvB,CACc1G,IADd;AAEjCf,EAAAA,GAAM,CAAC,gCAAD,EAAmCyH,IAAI,CAAC3J,OAAxC,CAAN;;AACA,QAAMA,OAAO,GAAG8J,2BAAO,CACrBhF,2BAAO,CACL6E,IAAI,CAAC3J,OADA,EAEL,CAAChC,MAAD,EAAShC,KAAT,EAAgB2B,GAAhB,uCACKK,MADL;AAEE,KAACL,GAAD,GAAO,CACL;AACEA,MAAAA,GAAG,EAAEuG,eAAe,CAACvG,GAAD,CADtB;AAEE3B,MAAAA,KAAK,EAAE2N,IAAI,CAAC3J,OAAL,CAAarC,GAAb;AAFT,KADK;AAFT,IAFK,EAWL,EAXK,CADc,EAcrB,CAAC3B,KAAD,EAAQ2B,GAAR,KAAgBuH,qBAAqB,CAAClJ,KAAK,CAAC,CAAD,CAAL,CAAS2B,GAAV,CAdhB,CAAvB;;AAgBAuE,EAAAA,GAAM,CAAC,kCAAD,EAAqClC,OAArC,CAAN;AACA,QAAMpB,QAAQ,GAAG;AACf0E,IAAAA,MADe;AAEfsG,IAAAA,iBAFe;AAGf5J,IAAAA,OAHe;AAIf4E,IAAAA,IAAI,EAAE3B,IAAI,CAACwG,QAAL,CAAc,QAAd,CAJS;AAKfM,IAAAA,YAAY,EAAE;AALC,GAAjB;AAOA,SAAOnL,QAAP;AACD,CA5BD;;AA8BA,MAAMoL,cAAc,GAAG,MAAM;AAC3B,MAAIhJ,QAAQ,GAAG5E,OAAO,CAAC4E,QAAvB;AACA,QAAM8H,GAAG,GAAG1M,OAAO,CAACsF,SAApB;AACA,QAAMsH,QAAQ,GAAI,kBAAiB5M,OAAO,CAAC2E,WAAY,IAAG+H,GAAI,EAA9D;;AAEA,MAAI9H,QAAQ,IAAI,EAAhB,EAAoB;AAClB,WAAO5D,KAAK,CAACM,GAAN,CAAUsL,QAAV,EAAoB,MAAM3J,EAAE,CAACkK,SAAH,CAAa;AAC5CR,MAAAA,MAAM,EAAE3M,OAAO,CAACoE,YAD4B;AAE5CsI,MAAAA;AAF4C,KAAb,EAG9BI,OAH8B,GAGpBnL,IAHoB,CAGf,CAAC;AACjByL,MAAAA;AADiB,KAAD,KAEZ;AACJtH,MAAAA,GAAM,CAAC,kBAAD,CAAN;AACA,aAAO;AACLoB,QAAAA,MAAM,EAAE,KADH;AAELsG,QAAAA,iBAAiB,EAAEK,IAAI,CAACC,YAAL,CAAkB,KAAlB,CAFd;AAGLlK,QAAAA,OAAO,EAAE;AACP,0BAAgB,CAAC;AACfrC,YAAAA,GAAG,EAAE,cADU;AAEf3B,YAAAA,KAAK,EAAE;AAFQ,WAAD;AADT,SAHJ;AASL4I,QAAAA,IAAI,EAAE4E,IAAI,CAACC,QAAL;AATD,OAAP;AAWD,KAlBgC,EAkB9BN,KAlB8B,CAkBxBxF,GAAG,IAAI;AACd,UAAIA,GAAG,CAACyF,SAAJ,KAAkB,WAAtB,EAAmC;AACjClH,QAAAA,GAAM,CAAC,sBAAD,CAAN;AACD;;AAEDA,MAAAA,GAAM,CAAC,mBAAD,EAAsByB,GAAtB,CAAN;AACA,aAAO,KAAP;AACD,KAzBgC,CAA1B,CAAP;AA0BD,GA3BD,MA2BO;AACL3C,IAAAA,QAAQ,GAAG,aAAaA,QAAb,GAAwB,GAAxB,GAA8B8H,GAAzC;AACA,WAAO1L,KAAK,CAACM,GAAN,CAAUsL,QAAV,EAAoB,MAAMtK,yBAAK,CAAC4K,OAAN,CAAc5L,GAAd,CAAkBsD,QAAlB,EAA4BjD,IAA5B,CAAiC,CAAC;AACjEa,MAAAA;AADiE,KAAD,KAE5D;AACJsD,MAAAA,GAAM,CAAC,kBAAD,CAAN;AACA,aAAO;AACLoB,QAAAA,MAAM,EAAE,KADH;AAELsG,QAAAA,iBAAiB,EAAEK,IAAI,CAACC,YAAL,CAAkB,KAAlB,CAFd;AAGLlK,QAAAA,OAAO,EAAE;AACP,0BAAgB,CAAC;AACfrC,YAAAA,GAAG,EAAE,cADU;AAEf3B,YAAAA,KAAK,EAAE;AAFQ,WAAD;AADT,SAHJ;AASL4I,QAAAA,IAAI,EAAEhG,QAAQ,CAACqE,IAAT,CAAcwG,QAAd;AATD,OAAP;AAWD,KAfgC,EAe9BN,KAf8B,CAexBxF,GAAG,IAAI;AACd,UAAIA,GAAG,CAACyF,SAAJ,KAAkB,WAAtB,EAAmC;AACjClH,QAAAA,GAAM,CAAC,sBAAD,CAAN;AACD;;AAEDA,MAAAA,GAAM,CAAC,mBAAD,EAAsByB,GAAtB,CAAN;AACA,aAAO,KAAP;AACD,KAtBgC,CAA1B,CAAP;AAuBD;AACF,CA1DD;AA6DA;AACA;;;AACA,MAAMX,QAAQ,GAAG,CAACgB,EAAD,EAAKV,MAAL,KAAgB;AAC/BpB,EAAAA,GAAM,CAAC,eAAD,EAAkB8B,EAAlB,EAAsBV,MAAtB,CAAN;AACA,SAAO;AACLA,IAAAA,MADK;AAELsG,IAAAA,iBAAiB,EAAEM,mBAAY,CAAC5G,MAAD,CAF1B;AAGLtD,IAAAA,OAAO,EAAE;AACPmK,MAAAA,QAAQ,EAAE,CAAC;AAAExM,QAAAA,GAAG,EAAE,UAAP;AAAmB3B,QAAAA,KAAK,EAAEgI;AAA1B,OAAD;AADH;AAHJ,GAAP;AAOD,CATD;;AAWA,MAAMP,OAAO;AAAA,gCAAG,WAAOO,EAAP,EAAW/D,IAAX,EAAiBN,KAAjB,EAA2B;AACzCuC,IAAAA,GAAM,CAAC,aAAD,EAAgB8B,EAAhB,CAAN;AACA,UAAM2F,IAAI,GACP,CAACpG,aAAa,CAACS,EAAD,CAAd,IACC,QAAQxB,YAAY,CAACwB,EAAD,CAApB,CADD,WAEQgG,cAAc,EAFtB,CAAD,IAGArO,SAAK,CAACgE,KAAD,EAAQ;AACXC,MAAAA,OAAO,EAAE,CACP;AACEC,QAAAA,EAAE,EAAE;AACFH,UAAAA,OAAO,EAAE;AACPM,YAAAA,OAAO,EAAE;AAAEC,cAAAA,IAAI,EAAE,CAAC;AAAEtC,gBAAAA,GAAG,EAAE,MAAP;AAAe3B,gBAAAA,KAAK,EAAEiE;AAAtB,eAAD;AAAR,aADF;AAEPoC,YAAAA,GAAG,EAAE2B;AAFE;AADP;AADN,OADO;AADE,KAAR,CAJP;AAgBA9B,IAAAA,GAAM,CAAC,mBAAD,EAAsBC,IAAI,CAACC,SAAL,CAAeuH,IAAf,CAAtB,CAAN;AACA,WAAOA,IAAP;AACD,GApBY;;AAAA,kBAAPlG,OAAO;AAAA;AAAA;AAAA,GAAb;;AAsBA,MAAMD,KAAK,GAAG,CAAC4G,GAAD,EAAMzK,KAAN,KAAgB;AAC5BuC,EAAAA,GAAM,CAAC,eAAD,EAAkBkI,GAAlB,CAAN;AAD4B,QAEpB1K,OAFoB,GAERC,KAAK,CAACC,OAAN,CAAc,CAAd,EAAiBC,EAFT,CAEpBH,OAFoB;;AAG5B,QAAM2K,MAAM,qCACP5F,kBAAkB,CAAC/E,OAAD,CADX;AAEV0K,IAAAA,GAFU;AAGVE,IAAAA,cAAc,EAAE,IAHN;AAIVC,IAAAA,gBAAgB,EAAE,OAJR;AAKVC,IAAAA,YAAY,EAAE;AALJ,IAAZ;;AAOAtI,EAAAA,GAAM,CAAC,gBAAD,EAAmBmI,MAAnB,CAAN;AACA,SAAO3L,yBAAK,CAAC2L,MAAD,CAAL,CACJtM,IADI,CACE4L,IAAD,IAAU;AACdzH,IAAAA,GAAM,CAAC,cAAD,EAAiB2C,yBAAK,CAAC8E,IAAD,EAAO,CAAC,SAAD,EAAY,QAAZ,CAAP,CAAtB,CAAN;AACA,WAAOD,gBAAgB,CAACC,IAAD,CAAvB;AACD,GAJI,EAKJR,KALI,CAKGxF,GAAD,IAAS;AACdzB,IAAAA,GAAM,CAAC,aAAD,EAAgByB,GAAhB,CAAN;AACA,UAAMA,GAAN;AACD,GARI,CAAP;AASD,CApBD;;AAsBA,eAAgBpE,IAAD,KAAW;AACxBkL,EAAAA,MAAM,EAAEnL,iBAAiB,CAACjE,IAAlB,CAAuB,IAAvB,EAA6BkE,IAA7B;AADgB,CAAX,CAAf;;ACpjBA,MAAMmL,SAAS,GAAG,mBAAlB;AACA,MAAMC,iBAAiB,GAAG,gCAA1B;AAEA,MAAMlN,KAAG,GAAG,GAAZ;;AACA,MAAML,OAAK,GAAG,IAAIqB,KAAJ,CAAiBhB,KAAjB,CAAd;AAEA,IAAImN,GAAJ;;AACA,MAAMC,aAAa;AAAA,+BAAG,WAAOtL,IAAI,GAAG,EAAd,EAAkBC,OAAlB,EAA2BC,IAA3B,EAAoC;AAAA,UAChDqL,OADgD,GACpCtL,OADoC,CAChDsL,OADgD;AAAA,UAEhDpL,OAFgD,GAEpCF,OAAO,CAACG,KAAR,CAAcC,OAAd,CAAsB,CAAtB,EAAyBC,EAFW,CAEhDH,OAFgD;AAAA,UAGhDI,MAHgD,GAGrCJ,OAHqC,CAGhDI,MAHgD;;AAAA,6BAIzCC,iBAAe,CAAC,CAAC,MAAD,CAAD,EAAWL,OAAO,CAACM,OAAnB,CAJ0B;AAAA;AAAA,UAIjDC,IAJiD;;AAKxD,UAAMI,YAAY,GAAGP,MAAM,IAAIA,MAAM,CAACQ,EAAjB,IAAuBR,MAAM,CAACQ,EAAP,CAAUC,UAAtD;AACA,UAAMC,YAAY,GAAGH,YAAY,IAAIA,YAAY,CAACI,OAAb,CAAqBiK,SAArB,EAAgC,EAAhC,CAArC;AAEA,UAAMK,WAAW,GAAG,YAApB;AACA,UAAMC,cAAc,GAAG,gBAAvB;AACA,UAAMtK,QAAQ,GAAG;AACfsK,MAAAA,cADe;AAEfD,MAAAA,WAFe;AAGfE,MAAAA,SAAS,EAAEC,wBAAwB,CACjCJ,OAAO,CAACK,YADyB,EAEjC5L,IAAI,CAACyL,cAAL,IAAuBA,cAFU,EAGjCzL,IAAI,CAACwL,WAAL,IAAoBA,WAHa,CAHpB;AAQfpJ,MAAAA,QAAQ,EAAElE;AARK,KAAjB;AAUA,UAAMrB,OAAO,GAAGT,SAAK,CAAC+E,QAAD,EAAWnB,IAAX,CAArB;AACAnC,IAAAA,OAAK,CAACgB,aAAN,CAAoBhC,OAAO,CAACuF,QAA5B;AAEAiJ,IAAAA,GAAG,GACDA,GAAG,IACH,IAAI3I,uBAAG,CAACmJ,QAAR,CAAiB;AACfC,MAAAA,UAAU,EAAE,YADG;AAEfC,MAAAA,MAAM,EAAE;AAFO,KAAjB,CAFF;AAOApJ,IAAAA,GAAM,CAAE;AACV;AACA,MAAMC,IAAI,CAACC,SAAL,CAAe5C,OAAO,CAACG,KAAvB,CAA8B;AACpC;AACA;AACA,MAAMwC,IAAI,CAACC,SAAL,CAAehG,OAAf,CAAwB;AAC9B;AACA,WAAWsD,OAAO,CAAC2C,GAAI;AACvB,YAAYpC,IAAK;AACjB,cAAcI,YAAa;AAC3B,KAVQ,CAAN;;AAYA,QAAI;AACF,YAAMkL,UAAU,SAASC,aAAa,CAACpP,OAAO,CAAC6O,SAAT,EAAoBhL,IAApB,CAAtC;AACAiC,MAAAA,GAAM,CAAC;AAAEqJ,QAAAA;AAAF,OAAD,CAAN;AACA/L,MAAAA,OAAO,CAACG,KAAR,GAAgB,CAAC,CAAC4L,UAAF,GACZE,2BAAO,CAAC9P,KAAR,CAAc6D,OAAO,CAACG,KAAtB,EAA6BgL,iBAA7B,EAAgD;AAC9CW,QAAAA,MAAM,EAAEC,UAAU,CAACD,MAD2B;AAE9C/K,QAAAA,UAAU,EAAEgL,UAAU,CAACzL;AAFuB,OAAhD,CADY,GAKZN,OAAO,CAACG,KALZ;AAMD,KATD,CASE,OAAOgE,GAAP,EAAY;AACZzB,MAAAA,GAAM,CAAC,gCAAD,CAAN;AACA,YAAMyB,GAAN;AACD;;AAED;AACD,GAzDkB;;AAAA,kBAAbkH,aAAa;AAAA;AAAA;AAAA,GAAnB;;AA2DA,uBAAgBtL,IAAD,KAAW;AACxBkL,EAAAA,MAAM,EAAEI,aAAa,CAACxP,IAAd,CAAmB,IAAnB,EAAyBkE,IAAzB;AADgB,CAAX,CAAf;AAKA;AACA;;AACA,MAAMQ,iBAAe,GAAG,CAAC6D,QAAD,EAAW5D,OAAX,KACtB4D,QAAQ,CAACC,GAAT,CACGC,KAAD,IAAW9D,OAAO,CAAC8D,KAAD,CAAP,IAAkB9D,OAAO,CAAC8D,KAAD,CAAP,CAAe,CAAf,CAAlB,IAAuC9D,OAAO,CAAC8D,KAAD,CAAP,CAAe,CAAf,EAAkB9H,KADtE,CADF;AAMA;;;AACA,MAAMkP,wBAAwB,GAAG,CAC/BC,YAD+B,EAE/BH,cAF+B,EAG/BD,WAH+B,KAI5B;AACH7I,EAAAA,GAAM,CAAE;AACV;AACA,IAAIC,IAAI,CAACC,SAAL,CAAe;AAAE+I,IAAAA,YAAF;AAAgBH,IAAAA,cAAhB;AAAgCD,IAAAA;AAAhC,GAAf,CAA8D;AAClE,GAHQ,CAAN;;AADG,gBAMDI,YAAY,CAACzI,KAAb,CAAoB,wBAAuBsI,cAAe,GAA1D,KAAiE,EANhE;AAAA;AAAA,QAKItP,IALJ;AAAA,QAKUgQ,SALV;;AAOH,SAAQ,GAAEA,SAAU,GAAEX,WAAY,EAAlC;AACD,CAZD;;AAcA,MAAMS,aAAa,GAAG,CAACG,KAAD,EAAQ1L,IAAR,KACpB7C,OAAK,CAACM,GAAN,CAAW,iBAAgBuC,IAAK,EAAhC,EAAmC,MACjC2K,GAAG,CAACgB,OAAJ,CAAY;AACV9C,EAAAA,GAAG,EAAE;AACH+C,IAAAA,IAAI,EAAE;AACJC,MAAAA,CAAC,EAAE7L;AADC;AADH,GADK;AAMV8L,EAAAA,SAAS,EAAEJ;AAND,CAAZ,EAQGzC,OARH,GASGnL,IATH,CASSkF,IAAD,IAAU;AACdf,EAAAA,GAAM,CAAE;AAChB;AACA,QAAQC,IAAI,CAACC,SAAL,CAAea,IAAf,CAAqB,EAFf,CAAN;AAGA,SACEA,IAAI,CAAC+I,IAAL,IACA/I,IAAI,CAAC+I,IAAL,CAAUC,MADV,IAEAhJ,IAAI,CAAC+I,IAAL,CAAUC,MAAV,CAAiBH,CAFjB,IAEsB;AACpB7L,IAAAA,IAAI,EAAEgD,IAAI,CAAC+I,IAAL,CAAUH,IAAV,CAAeC,CADD;AAEpBhM,IAAAA,MAAM,EAAEmD,IAAI,CAAC+I,IAAL,CAAUC,MAAV,CAAiBH,CAFL;AAGpBR,IAAAA,MAAM,EAAGrI,IAAI,CAAC+I,IAAL,CAAUE,MAAV,IAAoBjJ,IAAI,CAAC+I,IAAL,CAAUE,MAAV,CAAiBJ,CAAtC,IAA4C;AAHhC,GAHxB;AASD,CAtBH,CADF,CADF;;;;;"}